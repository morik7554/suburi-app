<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ç´ æŒ¯ã‚Šã‚«ã‚¦ãƒ³ãƒˆï¼ˆå®¶æ—ç”¨ï¼‰</title>
  <style>
    :root{
      --bg:#f7f7ff;
      --card:#ffffff;
      --ink:#1f2937;
      --muted:#6b7280;
      --accent:#4f46e5;
      --accent2:#22c55e;
      --danger:#ef4444;
      --shadow: 0 10px 25px rgba(0,0,0,.08);
      --radius: 18px;
      --btnRadius: 16px;
      --focus: 0 0 0 4px rgba(79,70,229,.18);
      --font: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--font);
      background: radial-gradient(1200px 800px at 20% 10%, #e9e7ff 0%, transparent 55%),
                  radial-gradient(900px 700px at 90% 40%, #e8fff1 0%, transparent 50%),
                  var(--bg);
      color:var(--ink);
    }
    header{
      position:sticky; top:0; z-index:10;
      backdrop-filter: blur(10px);
      background: rgba(247,247,255,.75);
      border-bottom: 1px solid rgba(17,24,39,.06);
    }
    .topbar{
      max-width:980px;
      margin:0 auto;
      padding:12px 14px;
      display:flex;
      align-items:center;
      gap:10px;
      justify-content:space-between;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      cursor:pointer;
      user-select:none;
    }
    .logo{
      width:40px; height:40px; border-radius:14px;
      background: linear-gradient(135deg, #4f46e5, #22c55e);
      box-shadow: var(--shadow);
      position:relative;
      overflow:hidden;
    }
    .logo:before{
      content:"";
      position:absolute; inset:-30%;
      background: radial-gradient(circle at 35% 35%, rgba(255,255,255,.9), transparent 55%);
      transform: rotate(18deg);
    }
    .brand h1{
      font-size:15px;
      margin:0;
      line-height:1.1;
    }
    .brand p{
      margin:0;
      font-size:12px;
      color:var(--muted);
    }
    .navbtns{display:flex; gap:8px; align-items:center;}
    .iconbtn{
      border:1px solid rgba(17,24,39,.12);
      background: rgba(255,255,255,.7);
      color:var(--ink);
      border-radius:14px;
      padding:10px 12px;
      font-size:13px;
      cursor:pointer;
      transition:.15s transform, .15s background, .15s border;
      display:flex; align-items:center; gap:8px;
      user-select:none;
    }
    .iconbtn:hover{transform: translateY(-1px); background:#fff; border-color: rgba(79,70,229,.25);}
    .iconbtn:focus{outline:none; box-shadow: var(--focus);}
    .iconbtn.active{
      background: rgba(79,70,229,.12);
      border-color: rgba(79,70,229,.22);
      color: var(--accent);
      font-weight:900;
    }

    main{
      max-width:980px;
      margin:0 auto;
      padding:16px 14px 90px;
    }

    .grid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:14px;
    }
    @media (max-width:860px){
      .grid{grid-template-columns:1fr}
    }

    .card{
      background: var(--card);
      border: 1px solid rgba(17,24,39,.08);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:16px;
    }

    .bigCount{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:10px;
      margin-bottom:12px;
    }
    .countNum{
      font-size:64px;
      font-weight:900;
      letter-spacing:-1px;
      margin:0;
      line-height:1;
    }
    .countLabel{
      margin:0;
      color:var(--muted);
      font-size:13px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:8px 10px;
      border-radius:999px;
      background: rgba(79,70,229,.10);
      color: var(--accent);
      font-weight:700;
      font-size:12px;
      border: 1px solid rgba(79,70,229,.18);
      user-select:none;
    }
    .pill.good{ background: rgba(34,197,94,.10); color: #16a34a; border-color: rgba(34,197,94,.18);}
    .pill.bad{ background: rgba(239,68,68,.10); color: #dc2626; border-color: rgba(239,68,68,.18);}

    .actions{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:10px;
    }
    .btn{
      border:none;
      border-radius: var(--btnRadius);
      padding:14px 14px;
      font-size:16px;
      font-weight:900;
      cursor:pointer;
      transition:.15s transform, .15s filter;
      user-select:none;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
    }
    .btn:active{transform: translateY(1px)}
    .btn.primary{background: linear-gradient(135deg, #4f46e5, #6d28d9); color:white;}
    .btn.green{background: linear-gradient(135deg, #22c55e, #16a34a); color:white;}
    .btn.gray{background: #f3f4f6; color:#111827; border:1px solid rgba(17,24,39,.10);}
    .btn.red{background: linear-gradient(135deg, #ef4444, #b91c1c); color:white;}
    .btn.small{padding:10px 12px; font-size:13px; border-radius:14px;}
    .btn.full{grid-column: 1 / -1;}
    .btn:focus{outline:none; box-shadow: var(--focus);}

    .tapArea{
      border-radius: var(--radius);
      border: 2px dashed rgba(79,70,229,.25);
      background: radial-gradient(600px 260px at 50% 10%, rgba(79,70,229,.10), transparent 55%),
                  radial-gradient(600px 260px at 50% 90%, rgba(34,197,94,.10), transparent 55%),
                  #fff;
      padding:14px;
      margin-top:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
      min-height:180px;
      position:relative;
      overflow:hidden;
    }
    .tapTitle{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .tapTitle h2{margin:0; font-size:15px;}
    .tapTitle span{font-size:12px; color:var(--muted);}
    .tapBtn{
      flex:1;
      border-radius: 18px;
      border:none;
      cursor:pointer;
      background: linear-gradient(135deg, rgba(79,70,229,.13), rgba(34,197,94,.12));
      font-size:18px;
      font-weight:900;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      min-height:86px;
      user-select:none;
      transition:.12s transform, .12s filter;
      color:#111827;
    }
    .tapBtn:active{transform: translateY(1px); filter: brightness(.98);}
    .tapBtn:focus{outline:none; box-shadow: var(--focus);}

    .sideTitle{
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      margin-bottom:10px;
    }
    .sideTitle h2{margin:0; font-size:15px;}
    .mini{font-size:12px; color:var(--muted);}

    .list{
      display:flex;
      flex-direction:column;
      gap:10px;
      max-height:620px;
      overflow:auto;
      padding-right:4px;
    }
    .entry{
      border:1px solid rgba(17,24,39,.08);
      border-radius: 16px;
      padding:12px 12px;
      background: #fff;
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:flex-start;
    }
    .entry .left{min-width:0;}
    .entry .date{font-weight:900; font-size:13px; margin-bottom:2px;}
    .entry .count{font-size:13px; color:#111827; font-weight:900; margin-bottom:6px;}
    .entry .sub{
      font-size:12px;
      color:var(--muted);
      white-space:pre-wrap;
      word-break:break-word;
    }
    .entry .right{display:flex; flex-direction:column; gap:6px; align-items:flex-end;}

    .hint{
      font-size:12px;
      color:var(--muted);
      line-height:1.6;
      background: rgba(243,244,246,.7);
      border: 1px solid rgba(17,24,39,.08);
      padding:10px 12px;
      border-radius: 16px;
    }

    /* Celebration overlay */
    .celebrate{
      position:absolute;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background: rgba(255,255,255,.86);
      backdrop-filter: blur(6px);
      z-index:20;
      cursor:pointer;
    }
    .celebrate .box{
      text-align:center;
      padding:18px 16px;
      border-radius: 22px;
      border: 1px solid rgba(17,24,39,.10);
      background:#fff;
      box-shadow: var(--shadow);
      width:min(420px, 92%);
      pointer-events:none; /* ã‚¿ãƒƒãƒ—ã§é–‰ã˜ã‚‹ã‚’å„ªå…ˆ */
    }
    .boom{
      font-size:40px;
      font-weight:1000;
      letter-spacing:.5px;
      margin:0 0 6px 0;
      background: linear-gradient(135deg, #ef4444, #f59e0b, #22c55e, #4f46e5);
      -webkit-background-clip:text;
      background-clip:text;
      color:transparent;
    }
    .subboom{margin:0; color:var(--muted); font-size:13px; font-weight:800;}
    .sparkles{
      display:flex;
      justify-content:center;
      gap:10px;
      margin-top:10px;
      font-size:22px;
      animation: floaty 1.2s ease-in-out infinite;
    }
    @keyframes floaty{
      0%,100%{transform: translateY(0)}
      50%{transform: translateY(-6px)}
    }

    footerBar{
      position:fixed;
      left:0; right:0; bottom:0;
      background: rgba(247,247,255,.82);
      backdrop-filter: blur(10px);
      border-top: 1px solid rgba(17,24,39,.06);
      padding:10px 14px;
      display:flex;
      justify-content:center;
      z-index:40;
    }
    .footerInner{
      width:min(980px, 100%);
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      color:var(--muted);
      font-size:12px;
    }
    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size:11px;
      background: rgba(17,24,39,.06);
      border:1px solid rgba(17,24,39,.08);
      padding:3px 6px;
      border-radius:8px;
      color:#111827;
    }

    /* Pages */
    .page{display:none;}
    .page.active{display:block;}
    .pageTitle{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin: 6px 2px 12px;
    }
    .pageTitle h2{margin:0; font-size:16px;}
    .tabs{
      display:flex; gap:8px; flex-wrap:wrap;
      margin: 10px 0 10px;
    }
    .tab{
      padding:10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(17,24,39,.10);
      background: rgba(255,255,255,.7);
      cursor:pointer;
      font-weight:800;
      font-size:13px;
      transition:.15s transform, .15s background, .15s border;
      user-select:none;
    }
    .tab.active{
      background: rgba(79,70,229,.12);
      border-color: rgba(79,70,229,.22);
      color: var(--accent);
    }
    .tab:hover{transform: translateY(-1px); background:#fff;}
    .tab:focus{outline:none; box-shadow: var(--focus);}

    .field{
      width:100%;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .label{
      font-size:12px;
      color:var(--muted);
      font-weight:800;
    }
    input[type="text"], textarea{
      width:100%;
      border:1px solid rgba(17,24,39,.12);
      border-radius: 16px;
      padding:12px 12px;
      font-size:14px;
      outline:none;
      transition:.15s box-shadow, .15s border;
      font-family:var(--font);
    }
    textarea{min-height:88px; resize:vertical;}
    input:focus, textarea:focus{border-color: rgba(79,70,229,.35); box-shadow: var(--focus);}

    .moodGrid{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:10px;
    }
    .moodBtn{
      border:1px solid rgba(17,24,39,.10);
      background:#fff;
      border-radius: 16px;
      padding:12px 10px;
      cursor:pointer;
      font-size:22px;
      font-weight:900;
      display:flex;
      align-items:center;
      justify-content:center;
      transition:.15s transform, .15s background, .15s border;
      user-select:none;
    }
    .moodBtn.active{
      border-color: rgba(79,70,229,.28);
      background: rgba(79,70,229,.10);
    }
    .moodBtn:hover{transform: translateY(-1px);}
    .moodBtn:focus{outline:none; box-shadow: var(--focus);}

    .modalOverlay{
      position:fixed;
      inset:0;
      background: rgba(17,24,39,.45);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:50;
    }
    .modal{
      width:min(540px, 100%);
      background:#fff;
      border-radius: 22px;
      box-shadow: 0 30px 80px rgba(0,0,0,.25);
      border: 1px solid rgba(17,24,39,.10);
      overflow:hidden;
    }
    .modalHead{
      padding:14px 14px;
      background: radial-gradient(700px 260px at 10% 10%, rgba(79,70,229,.12), transparent 55%),
                  radial-gradient(700px 260px at 90% 40%, rgba(34,197,94,.12), transparent 55%),
                  #fff;
      border-bottom: 1px solid rgba(17,24,39,.08);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .modalHead h3{
      margin:0;
      font-size:15px;
      font-weight:1000;
    }
    .modalBody{padding:14px; display:flex; flex-direction:column; gap:12px;}
  </style>
</head>
<body>
<header>
  <div class="topbar">
    <div class="brand" id="brandHome" title="ãƒ›ãƒ¼ãƒ ã¸">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <h1>ç´ æŒ¯ã‚Šã‚«ã‚¦ãƒ³ãƒˆï¼ˆå®¶æ—ç”¨ï¼‰</h1>
        <p id="statusLine">æº–å‚™OK</p>
      </div>
    </div>
    <div class="navbtns">
      <button class="iconbtn" id="btnNavHistory" title="å±¥æ­´ãƒšãƒ¼ã‚¸ã¸">ğŸ“’ å±¥æ­´</button>
      <button class="iconbtn" id="btnNavSettings" title="è¨­å®šãƒšãƒ¼ã‚¸ã¸">âš™ï¸ è¨­å®š</button>
      <button class="iconbtn" id="btnNavData" title="ãƒ‡ãƒ¼ã‚¿">ğŸ’¾ ãƒ‡ãƒ¼ã‚¿</button>
    </div>
  </div>
</header>

<main>

  <!-- ========== HOME PAGE ========== -->
  <section class="page active" id="pageHome" aria-label="ãƒ›ãƒ¼ãƒ ">
    <div class="grid">
      <section class="card" aria-label="ãƒ¡ã‚¤ãƒ³">
        <div class="bigCount">
          <div>
            <p class="countLabel">ä»Šæ—¥ã®ã‚«ã‚¦ãƒ³ãƒˆ</p>
            <p class="countNum" id="countNum">0</p>
          </div>
          <div style="display:flex; flex-direction:column; gap:8px; align-items:flex-end;">
            <span class="pill" id="runPill">â¸ åœæ­¢ä¸­</span>
            <span class="pill good" id="voicePill" style="display:none;">ğŸ™ éŸ³å£°ON</span>
          </div>
        </div>

        <div class="actions">
          <button class="btn primary" id="btnStart">â–¶ï¸ Start</button>
          <button class="btn red" id="btnStop" disabled>â¹ Stop</button>
          <button class="btn gray full" id="btnReset">ğŸ” ä»Šæ—¥ã®ã‚«ã‚¦ãƒ³ãƒˆã‚’0ã«æˆ»ã™</button>
        </div>

        <div class="tapArea" id="tapArea">
          <div class="tapTitle">
            <h2>ãƒ¡ã‚¤ãƒ³ç”»é¢ã¯ã‚·ãƒ³ãƒ—ãƒ«</h2>
            <span id="tapHint">Startä¸­ã ã‘ã‚¿ãƒƒãƒ—ã§+1</span>
          </div>

          <button class="tapBtn" id="tapBtn" disabled>ğŸ‘† ã‚¿ãƒƒãƒ—ã§ +1</button>

          <div class="hint" id="voiceHintBox" style="display:none;">
            <div style="font-weight:900; color:#111827; margin-bottom:6px;">éŸ³å£°ã‚«ã‚¦ãƒ³ãƒˆã®ä½¿ã„æ–¹</div>
            <div id="voiceHintText"></div>
          </div>

          <!-- Celebration overlay (auto close) -->
          <div class="celebrate" id="celebrate" title="ã‚¿ãƒƒãƒ—ã§é–‰ã˜ã‚‹">
            <div class="box">
              <p class="boom">ğŸ‰ HOME RUN!! ğŸ‰</p>
              <p class="subboom">10å›ã”ã¨ã«è¡¨ç¤º</p>
              <div class="sparkles">âœ¨ âš¾ âœ¨</div>
            </div>
          </div>
        </div>
      </section>

      <aside class="card" aria-label="ã‚µãƒãƒªãƒ¼">
        <div class="sideTitle">
          <h2>ã‚µãƒãƒªãƒ¼</h2>
          <div class="mini" id="summaryMini">â€”</div>
        </div>

        <div class="hint" style="margin-bottom:10px;">
          å±¥æ­´ã¯ã€ŒğŸ“’ å±¥æ­´ã€ãƒšãƒ¼ã‚¸ã§ã¾ã¨ã‚ã¦è¦‹ã‚‰ã‚Œã¾ã™ã€‚
        </div>

        <div class="entry">
          <div class="left">
            <div class="date">ä»Šé€±ï¼ˆMonã€œSunï¼‰</div>
            <div class="count" id="weekTotal">0 å›</div>
            <div class="sub mini" id="weekRange">â€”</div>
          </div>
          <div class="right"><span class="pill good">ğŸ“… WEEK</span></div>
        </div>

        <div class="entry">
          <div class="left">
            <div class="date">ä»Šæœˆ</div>
            <div class="count" id="monthTotal">0 å›</div>
            <div class="sub mini" id="monthLabel">â€”</div>
          </div>
          <div class="right"><span class="pill">ğŸ—“ MONTH</span></div>
        </div>

        <div class="entry">
          <div class="left">
            <div class="date">ç´¯è¨ˆ</div>
            <div class="count" id="allTotal">0 å›</div>
            <div class="sub mini">å…¨å±¥æ­´ã®åˆè¨ˆ</div>
          </div>
          <div class="right"><span class="pill bad">ğŸ TOTAL</span></div>
        </div>

        <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btn small gray" id="btnGoHistory">ğŸ“’ å±¥æ­´ã‚’è¦‹ã‚‹</button>
          <button class="btn small gray" id="btnGoSettings">âš™ï¸ è¨­å®šã‚’é–‹ã</button>
        </div>
      </aside>
    </div>
  </section>

  <!-- ========== HISTORY PAGE ========== -->
  <section class="page" id="pageHistory" aria-label="å±¥æ­´ãƒšãƒ¼ã‚¸">
    <div class="pageTitle">
      <h2>ğŸ“’ å±¥æ­´</h2>
      <button class="btn small gray" id="btnBackFromHistory">â† ãƒ›ãƒ¼ãƒ </button>
    </div>

    <div class="card">
      <div class="tabs" role="tablist" aria-label="è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ">
        <button class="tab active" id="tabHistory" role="tab" aria-selected="true">å±¥æ­´</button>
        <button class="tab" id="tabTotals" role="tab" aria-selected="false">åˆè¨ˆ</button>
      </div>

      <div id="panelHistory">
        <div class="row" style="display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; margin-bottom:10px;">
          <button class="btn small gray" id="btnClearHistory">ğŸ—‘ å±¥æ­´ã‚’å…¨å‰Šé™¤</button>
          <div style="display:flex; gap:10px; flex-wrap:wrap;">
            <button class="btn small gray" id="btnExportCSV">ğŸ“„ CSV</button>
          </div>
        </div>
        <div class="list" id="historyList"></div>
      </div>

      <div id="panelTotals" style="display:none;">
        <div class="hint" style="margin-bottom:10px;">
          é€±ãƒ»æœˆãƒ»ç´¯è¨ˆã®åˆè¨ˆå›æ•°ã‚’è¡¨ç¤ºã—ã¾ã™ï¼ˆå±¥æ­´ã‹ã‚‰è‡ªå‹•é›†è¨ˆï¼‰ã€‚
        </div>

        <div class="entry">
          <div class="left">
            <div class="date">ä»Šé€±ï¼ˆMonã€œSunï¼‰</div>
            <div class="count" id="weekTotal2">0 å›</div>
            <div class="sub mini" id="weekRange2">â€”</div>
          </div>
          <div class="right"><span class="pill good">ğŸ“… WEEK</span></div>
        </div>

        <div class="entry">
          <div class="left">
            <div class="date">ä»Šæœˆ</div>
            <div class="count" id="monthTotal2">0 å›</div>
            <div class="sub mini" id="monthLabel2">â€”</div>
          </div>
          <div class="right"><span class="pill">ğŸ—“ MONTH</span></div>
        </div>

        <div class="entry">
          <div class="left">
            <div class="date">ç´¯è¨ˆ</div>
            <div class="count" id="allTotal2">0 å›</div>
            <div class="sub mini">å…¨å±¥æ­´ã®åˆè¨ˆ</div>
          </div>
          <div class="right"><span class="pill bad">ğŸ TOTAL</span></div>
        </div>
      </div>
    </div>
  </section>

  <!-- ========== SETTINGS PAGE ========== -->
  <section class="page" id="pageSettings" aria-label="è¨­å®šãƒšãƒ¼ã‚¸">
    <div class="pageTitle">
      <h2>âš™ï¸ è¨­å®š</h2>
      <button class="btn small gray" id="btnBackFromSettings">â† ãƒ›ãƒ¼ãƒ </button>
    </div>

    <div class="card">
      <div class="entry" style="align-items:center;">
        <div class="left">
          <div class="date">éŸ³ï¼ˆåŠ¹æœéŸ³ï¼‰</div>
          <div class="sub">ãƒ›ãƒ¼ãƒ ãƒ©ãƒ³æ™‚ã®ã€Œã‚«ã‚­ãƒ¼ãƒ³ã€ã‚’é³´ã‚‰ã—ã¾ã™ã€‚</div>
        </div>
        <div class="right">
          <button class="btn small green" id="toggleSound">ON</button>
        </div>
      </div>

      <div class="entry" style="align-items:center; margin-top:10px;">
        <div class="left">
          <div class="date">éŸ³å£°å…¥åŠ›</div>
          <div class="sub">ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§ +1 ã‚«ã‚¦ãƒ³ãƒˆã—ã¾ã™ã€‚</div>
        </div>
        <div class="right">
          <button class="btn small gray" id="toggleVoice">OFF</button>
        </div>
      </div>

      <div class="field" style="margin-top:10px;">
        <div class="label">éŸ³å£°ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼ˆä¾‹ï¼šã¯ã„ / ã‚ˆã— / ã„ããï¼‰</div>
        <input type="text" id="voiceKeyword" placeholder="ã¯ã„" maxlength="12" />
        <div class="mini">â€»ã€Œã¯ã„ã€ã¯ï¼ˆãƒã‚¤/ã¯ã„ã£/ã¯ã„ã€‚/haiç­‰ï¼‰ã‚‚æ‹¾ã†ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚</div>
      </div>

      <div class="hint" style="margin-top:10px;">
        <div style="font-weight:900; color:#111827; margin-bottom:6px;">éŸ³å£°ãŒã†ã¾ãã„ã‹ãªã„æ™‚ã®å¯¾ç­–ï¼ˆå†…è”µï¼‰</div>
        <div>
          ãƒ»ã²ã‚‰ãŒãª/ã‚«ã‚¿ã‚«ãƒŠã‚’æ­£è¦åŒ–ã—ã¦åˆ¤å®š<br>
          ãƒ»ã€Œã¯ã„ã£ã€ã€Œã¯ã„ã€‚ã€ãªã©ã®è¡¨è¨˜ã‚†ã‚Œã‚‚OK<br>
          ãƒ»åŒã˜èªè­˜ãŒçŸ­æ™‚é–“ã«ç¶šã„ãŸã‚‰ç„¡è¦–ï¼ˆ2é‡ã‚«ã‚¦ãƒ³ãƒˆå¯¾ç­–ï¼‰<br>
          ãƒ»æ­¢ã¾ã‚Šã‚„ã™ã„å ´åˆã¯è‡ªå‹•ã§å†é–‹
        </div>
      </div>
    </div>
  </section>

</main>

<footerBar>
  <div class="footerInner">
    <div>ä¿å­˜å…ˆï¼š<span class="kbd">localStorage</span>ï¼ˆã“ã®ãƒ–ãƒ©ã‚¦ã‚¶å†…ï¼‰</div>
    <div>ãƒ‡ãƒ¼ã‚¿ä¿è­·ï¼š<span class="kbd">JSONãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</span>æ¨å¥¨</div>
  </div>
</footerBar>

<!-- Data Modal -->
<div class="modalOverlay" id="modalDataOverlay" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-label="ãƒ‡ãƒ¼ã‚¿">
    <div class="modalHead">
      <h3>ğŸ’¾ ãƒ‡ãƒ¼ã‚¿</h3>
      <button class="btn small gray" id="btnDataClose">é–‰ã˜ã‚‹</button>
    </div>
    <div class="modalBody">
      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <button class="btn small gray" id="btnBackupJSON">â¬‡ï¸ JSONãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</button>
        <label class="btn small gray" style="cursor:pointer;">
          â¬†ï¸ JSONå¾©å…ƒ
          <input type="file" id="restoreJSONFile" accept="application/json" style="display:none;" />
        </label>
      </div>

      <div class="hint">
        CSVã¯Excelç­‰ã§é–‹ã‘ã¾ã™ã€‚JSONã¯ã€Œä¸¸ã”ã¨ä¿å­˜ãƒ»å¾©å…ƒã€ç”¨ã§ã™ã€‚
        ç«¯æœ«ã‚„ãƒ–ãƒ©ã‚¦ã‚¶ã‚’å¤‰ãˆã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãªã‚‰ã€JSONãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒå®‰å¿ƒã§ã™ã€‚
      </div>
    </div>
  </div>
</div>

<!-- Save Modal -->
<div class="modalOverlay" id="modalSaveOverlay" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-label="è¨˜éŒ²ã‚’ä¿å­˜">
    <div class="modalHead">
      <h3>ğŸ“ ä»Šæ—¥ã®è¨˜éŒ²</h3>
      <button class="btn small gray" id="btnSaveCancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
    <div class="modalBody">
      <div class="hint" id="saveHint"></div>

      <div>
        <div class="label">æ°—åˆ†</div>
        <div class="moodGrid" id="moodGrid">
          <button class="moodBtn" data-mood="ğŸ˜ƒ" type="button">ğŸ˜ƒ</button>
          <button class="moodBtn" data-mood="ğŸ™‚" type="button">ğŸ™‚</button>
          <button class="moodBtn" data-mood="ğŸ˜Œ" type="button">ğŸ˜Œ</button>
          <button class="moodBtn" data-mood="ğŸ˜”" type="button">ğŸ˜”</button>
        </div>
      </div>

      <div class="field">
        <div class="label">ä»Šæ—¥ã®æ„Ÿæƒ³ï¼ˆçŸ­ãã§OKï¼‰</div>
        <textarea id="commentBox" placeholder="ä¾‹ï¼šãƒ•ã‚©ãƒ¼ãƒ ãŒè‰¯ã‹ã£ãŸã€‚æœ€å¾Œã¡ã‚‡ã£ã¨ç–²ã‚ŒãŸã€‚"></textarea>
      </div>

      <button class="btn green" id="btnSaveDone">âœ… ä¿å­˜ã™ã‚‹</button>
    </div>
  </div>
</div>

<script>
(() => {
  const LS_KEYS = {
    history: "suburi_history_v4",
    settings: "suburi_settings_v4",
    session: "suburi_session_v4"
  };

  const $ = (sel) => document.querySelector(sel);
  const $$ = (sel) => Array.from(document.querySelectorAll(sel));

  // Pages
  const pageHome = $("#pageHome");
  const pageHistory = $("#pageHistory");
  const pageSettings = $("#pageSettings");

  const btnNavHistory = $("#btnNavHistory");
  const btnNavSettings = $("#btnNavSettings");
  const btnNavData = $("#btnNavData");
  const brandHome = $("#brandHome");
  const btnGoHistory = $("#btnGoHistory");
  const btnGoSettings = $("#btnGoSettings");
  const btnBackFromHistory = $("#btnBackFromHistory");
  const btnBackFromSettings = $("#btnBackFromSettings");

  // Home UI
  const countNum = $("#countNum");
  const runPill = $("#runPill");
  const voicePill = $("#voicePill");
  const statusLine = $("#statusLine");
  const btnStart = $("#btnStart");
  const btnStop  = $("#btnStop");
  const btnReset = $("#btnReset");
  const tapBtn   = $("#tapBtn");
  const celebrate = $("#celebrate");
  const voiceHintBox = $("#voiceHintBox");
  const voiceHintText = $("#voiceHintText");
  const summaryMini = $("#summaryMini");

  // Totals (Home + History)
  const weekTotal = $("#weekTotal");
  const monthTotal = $("#monthTotal");
  const allTotal = $("#allTotal");
  const weekRange = $("#weekRange");
  const monthLabel = $("#monthLabel");

  const weekTotal2 = $("#weekTotal2");
  const monthTotal2 = $("#monthTotal2");
  const allTotal2 = $("#allTotal2");
  const weekRange2 = $("#weekRange2");
  const monthLabel2 = $("#monthLabel2");

  // History page
  const tabHistory = $("#tabHistory");
  const tabTotals  = $("#tabTotals");
  const panelHistory = $("#panelHistory");
  const panelTotals  = $("#panelTotals");
  const historyList = $("#historyList");
  const btnClearHistory = $("#btnClearHistory");
  const btnExportCSV = $("#btnExportCSV");

  // Settings page
  const toggleSound = $("#toggleSound");
  const toggleVoice = $("#toggleVoice");
  const voiceKeywordInput = $("#voiceKeyword");

  // Modals
  const modalDataOverlay = $("#modalDataOverlay");
  const btnDataClose = $("#btnDataClose");
  const btnBackupJSON = $("#btnBackupJSON");
  const restoreJSONFile = $("#restoreJSONFile");

  const modalSaveOverlay = $("#modalSaveOverlay");
  const saveHint = $("#saveHint");
  const moodGrid = $("#moodGrid");
  const commentBox = $("#commentBox");
  const btnSaveDone = $("#btnSaveDone");
  const btnSaveCancel = $("#btnSaveCancel");

  // State
  let settings = { soundEnabled: true, voiceEnabled: false, voiceKeyword: "ã¯ã„" };
  let history = [];
  let session = { running: false, todayCount: 0, startedAtISO: null };

  // Speech recognition
  let recognition = null;
  let isRecognizing = false;
  let lastAccepted = { key: "", t: 0 };

  // Celebration timer
  let celebrateTimer = null;

  // Audio
  let audioCtx = null;

  const safeJSONParse = (str, fallback) => { try { return JSON.parse(str); } catch { return fallback; } };
  const saveLS = () => {
    localStorage.setItem(LS_KEYS.settings, JSON.stringify(settings));
    localStorage.setItem(LS_KEYS.history, JSON.stringify(history));
    localStorage.setItem(LS_KEYS.session, JSON.stringify(session));
  };
  const loadLS = () => {
    const s = safeJSONParse(localStorage.getItem(LS_KEYS.settings), null);
    const h = safeJSONParse(localStorage.getItem(LS_KEYS.history), null);
    const se = safeJSONParse(localStorage.getItem(LS_KEYS.session), null);
    if (s && typeof s === "object") settings = {...settings, ...s};
    if (Array.isArray(h)) history = h;
    if (se && typeof se === "object") session = {...session, ...se};
  };

  const setStatus = (text) => { statusLine.textContent = text; };

  const openModal = (overlay) => { overlay.style.display = "flex"; overlay.setAttribute("aria-hidden","false"); };
  const closeModal = (overlay) => { overlay.style.display = "none"; overlay.setAttribute("aria-hidden","true"); };

  const clampInt = (n) => Number.isFinite(n) ? Math.max(0, Math.floor(n)) : 0;

  const pad2 = (n) => String(n).padStart(2,"0");
  const formatDateJP = (d) => `${d.getFullYear()}/${pad2(d.getMonth()+1)}/${pad2(d.getDate())}`;
  const nowISO = () => new Date().toISOString();

  /* ===============================
     ãƒšãƒ¼ã‚¸åˆ‡æ›¿ï¼ˆåŒä¸€ãƒ•ã‚¡ã‚¤ãƒ«å†…ï¼‰
     =============================== */
  const setActiveNav = (page) => {
    [btnNavHistory, btnNavSettings].forEach(b => b.classList.remove("active"));
    if (page === "history") btnNavHistory.classList.add("active");
    if (page === "settings") btnNavSettings.classList.add("active");
  };

  const showPage = (name) => {
    [pageHome, pageHistory, pageSettings].forEach(p => p.classList.remove("active"));
    if (name === "home") pageHome.classList.add("active");
    if (name === "history") pageHistory.classList.add("active");
    if (name === "settings") pageSettings.classList.add("active");
    setActiveNav(name);
    if (name === "history") { renderHistory(); updateTotals(); }
    if (name === "settings") { updateSettingsUI(); }
  };

  /* ===============================
     Audio (kakiin)
     =============================== */
  const ensureAudio = () => {
    if (!audioCtx) {
      const Ctx = window.AudioContext || window.webkitAudioContext;
      if (!Ctx) return null;
      audioCtx = new Ctx();
    }
    return audioCtx;
  };

  const playKakiin = async () => {
    if (!settings.soundEnabled) return;
    const ctx = ensureAudio();
    if (!ctx) return;
    if (ctx.state === "suspended") { try { await ctx.resume(); } catch {} }
    const t0 = ctx.currentTime;

    const tone = (freq, start, dur, type="triangle", gain=0.12) => {
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.type = type;
      o.frequency.setValueAtTime(freq, start);
      g.gain.setValueAtTime(0.0001, start);
      g.gain.exponentialRampToValueAtTime(gain, start + 0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, start + dur);
      o.connect(g).connect(ctx.destination);
      o.start(start);
      o.stop(start + dur + 0.02);
    };

    tone(880,  t0 + 0.00, 0.10, "square",   0.10);
    tone(1320, t0 + 0.02, 0.12, "triangle", 0.08);
    tone(660,  t0 + 0.07, 0.16, "sine",     0.06);
  };

  /* ===============================
     Celebration (auto close)
     =============================== */
  const showCelebration = () => {
    celebrate.style.display = "flex";
    if (celebrateTimer) clearTimeout(celebrateTimer);
    celebrateTimer = setTimeout(() => {
      celebrate.style.display = "none";
    }, 1400); // â† è‡ªå‹•ã§é–‰ã˜ã‚‹
  };
  const hideCelebration = () => {
    celebrate.style.display = "none";
    if (celebrateTimer) clearTimeout(celebrateTimer);
    celebrateTimer = null;
  };

  celebrate.addEventListener("click", hideCelebration);

  /* ===============================
     Speech recognition improvements
     - ã²ã‚‰ãŒãª/ã‚«ã‚¿ã‚«ãƒŠæ­£è¦åŒ–
     - è¨˜å·é™¤å»
     - ã€Œã¯ã„ã€ã®è¡¨è¨˜ã‚†ã‚Œã‚’åºƒã‚ã«è¨±å¯
     =============================== */

  const supportsSpeech = () => ("webkitSpeechRecognition" in window) || ("SpeechRecognition" in window);

  // ã‚«ã‚¿ã‚«ãƒŠâ†’ã²ã‚‰ãŒãªï¼ˆç°¡æ˜“ï¼‰
  const kataToHira = (s) => s.replace(/[\u30A1-\u30F6]/g, ch => String.fromCharCode(ch.charCodeAt(0) - 0x60));

  const normalizeSpeech = (s) => {
    if (!s) return "";
    let t = String(s).trim();
    t = t.replace(/\s+/g, "");
    // å…¨è§’è‹±æ•°â†’åŠè§’
    t = t.replace(/[ï¼-ï½]/g, ch => String.fromCharCode(ch.charCodeAt(0) - 0xFEE0));
    // è¨˜å·é™¤å»ï¼ˆå¥èª­ç‚¹/ä¼¸ã°ã—/å°æ–‡å­—ãªã©ã¯æ®‹ã—ã¦ã‚‚OKã ãŒã€åˆ¤å®šã‚’å®‰å®šã•ã›ã‚‹ï¼‰
    t = t.replace(/[ã€ã€‚,.!ï¼?ï¼Ÿã€Œã€"â€'â€™ï¼ˆï¼‰()ï¼»ï¼½\[\]{}]/g, "");
    // ã‚«ã‚¿ã‚«ãƒŠâ†’ã²ã‚‰ãŒãª
    t = kataToHira(t);
    // ä¼¸ã°ã—æ£’ã‚’é™¤å»ï¼ˆã¯ã„ãƒ¼ç­‰ï¼‰
    t = t.replace(/ãƒ¼+/g, "");
    // å°ã•ã„ã€Œã£ã€ã‚’é™¤å»ï¼ˆã¯ã„ã£ï¼‰
    t = t.replace(/ã£+/g, "");
    // è‹±èªã®hi/haiã‚‚è¨±å¯ã—ãŸã„ã®ã§å°æ–‡å­—åŒ–
    t = t.toLowerCase();
    return t;
  };

  const isNumericOnly = (s) => /^[0-9ï¼-ï¼™]+$/.test(s);

  // ã€Œã¯ã„ã€åˆ¤å®šã‚’åºƒã‚ã«ï¼škwä¸€è‡´ + æ—¢å®šã®æºã‚Œ
  const matchKeyword = (transcript, kw) => {
    const t = normalizeSpeech(transcript);
    const k = normalizeSpeech(kw || "ã¯ã„");

    if (!t || !k) return false;

    // æ•°å­—ã ã‘ã¯ç„¡è¦–
    if (isNumericOnly(transcript)) return false;

    // ã¾ãšé€šå¸¸ä¸€è‡´
    if (t.includes(k)) return true;

    // ã€Œã¯ã„ã€ç³»ã®æºã‚Œï¼ˆkwãŒã€Œã¯ã„ã€ã£ã½ã„å ´åˆï¼‰
    const kwIsHai = (k === "ã¯ã„" || k === "ã¯ãƒ" || k === "hai" || k === "hi");
    if (kwIsHai) {
      const variants = ["ã¯ã„","ã¯ãƒ","hai","hi","ãƒã‚¤","ã¯ã„ãƒ¼","ã¯ã„ã£","ã¯ãƒ¼ã„","ã»ã„"];
      return variants.map(v => normalizeSpeech(v)).some(vn => vn && t.includes(vn));
    }

    return false;
  };

  const setupRecognition = () => {
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SR) return null;

    const rec = new SR();
    rec.lang = "ja-JP";
    rec.interimResults = true;
    rec.continuous = true;
    rec.maxAlternatives = 1;

    rec.onstart = () => {
      isRecognizing = true;
      updateVoicePill();
      if (settings.voiceEnabled && session.running) setStatus("éŸ³å£°å¾…æ©Ÿä¸­â€¦");
    };

    rec.onerror = (e) => {
      isRecognizing = false;
      updateVoicePill();
      setStatus(`éŸ³å£°ã‚¨ãƒ©ãƒ¼: ${e.error || "unknown"}`);
    };

    rec.onend = () => {
      isRecognizing = false;
      updateVoicePill();
      // èµ°è¡Œä¸­ï¼‹éŸ³å£°ONãªã‚‰ã€å°‘ã—å¾…ã£ã¦å†é–‹ï¼ˆå†é–‹å¼·åŒ–ï¼‰
      if (settings.voiceEnabled && session.running) {
        setTimeout(() => tryStartRecognition(true), 250);
      }
    };

    rec.onresult = (event) => {
      // æœ€æ–°çµæœ
      const res = event.results[event.results.length - 1];
      if (!res) return;

      const transcript = (res[0]?.transcript || "").trim();
      if (!transcript) return;

      // finalå„ªå…ˆã€ãŸã ã—finalãŒæ¥ãªã„ç’°å¢ƒãŒã‚ã‚‹ã®ã§ã€Œinterimã§ã‚‚å¼·ä¸€è‡´ãªã‚‰1å›ã ã‘ã€è¨±å¯
      const okByFinal = !!res.isFinal;
      const okByStrongInterim = (!res.isFinal && matchKeyword(transcript, settings.voiceKeyword));

      if (!(okByFinal || okByStrongInterim)) return;
      if (!session.running) return;

      // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ä¸€è‡´å¿…é ˆ
      if (!matchKeyword(transcript, settings.voiceKeyword)) return;

      // é‡è¤‡æŠ‘åˆ¶ï¼ˆåŒä¸€ã‚­ãƒ¼ã¯çŸ­æ™‚é–“ç„¡è¦–ï¼‰
      const now = Date.now();
      const key = normalizeSpeech(transcript) + "|" + normalizeSpeech(settings.voiceKeyword);
      if (lastAccepted.key === key && (now - lastAccepted.t) < 900) return;

      lastAccepted = { key, t: now };

      incrementCount(1, { from: "voice", transcript });
    };

    return rec;
  };

  const tryStartRecognition = (silent=false) => {
    if (!supportsSpeech()) {
      if (!silent) alert("ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°å…¥åŠ›ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚");
      settings.voiceEnabled = false;
      saveLS();
      updateSettingsUI();
      updateVoicePill();
      return;
    }
    if (!recognition) recognition = setupRecognition();
    if (!recognition) return;
    if (isRecognizing) return;

    try { recognition.start(); } catch(e) {}
  };

  const stopRecognition = () => {
    if (!recognition) return;
    try { recognition.stop(); } catch(e) {}
  };

  const updateVoiceHint = () => {
    if (!settings.voiceEnabled) {
      voiceHintBox.style.display = "none";
      return;
    }
    const kw = (settings.voiceKeyword || "ã¯ã„").trim();
    voiceHintBox.style.display = "block";
    voiceHintText.innerHTML =
      `Startä¸­ã« <b>ã€Œ${kw}ã€</b> ã¨è¨€ã†ã¨ +1 ã•ã‚Œã¾ã™ã€‚<br>` +
      `ï¼ˆã€Œã¯ã„ã€ã¯ãƒã‚¤/ã¯ã„ã£/ã¯ã„ã€‚/haiç­‰ã‚‚OKï¼‰<br>` +
      `ï¼ˆèª¤ã‚«ã‚¦ãƒ³ãƒˆå¯¾ç­–ï¼šçŸ­æ™‚é–“ã®é‡è¤‡ã¯ç„¡è¦–ï¼‰`;
  };

  /* ===============================
     Core actions
     =============================== */
  const updateVoicePill = () => {
    if (settings.voiceEnabled) {
      voicePill.style.display = "inline-flex";
      voicePill.textContent = isRecognizing ? "ğŸ™ éŸ³å£°ONï¼ˆå¾…æ©Ÿä¸­ï¼‰" : "ğŸ™ éŸ³å£°ON";
      voicePill.className = "pill good";
    } else {
      voicePill.style.display = "none";
    }
  };

  const updateMainUI = () => {
    countNum.textContent = String(session.todayCount);

    if (session.running) {
      runPill.textContent = "â–¶ï¸ è¨ˆæ¸¬ä¸­";
      runPill.className = "pill good";
      btnStart.disabled = true;
      btnStop.disabled = false;
      tapBtn.disabled = false;
      $("#tapHint").textContent = "ã‚¿ãƒƒãƒ—ã§ã©ã‚“ã©ã‚“ã‚«ã‚¦ãƒ³ãƒˆï¼";
    } else {
      runPill.textContent = "â¸ åœæ­¢ä¸­";
      runPill.className = "pill";
      btnStart.disabled = false;
      btnStop.disabled = true;
      tapBtn.disabled = true;
      $("#tapHint").textContent = "Startä¸­ã ã‘ã‚¿ãƒƒãƒ—ã§+1";
    }

    updateVoicePill();
    updateVoiceHint();
    updateSummaryMini();
  };

  const incrementCount = (delta=1) => {
    const before = session.todayCount;
    session.todayCount = clampInt(session.todayCount + delta);
    saveLS();
    updateMainUI();

    const after = session.todayCount;
    if (after > 0 && after % 10 === 0 && after !== before) {
      showCelebration();
      playKakiin();
    }
  };

  const startRun = () => {
    session.running = true;
    session.startedAtISO = nowISO();
    saveLS();
    updateMainUI();
    setStatus("è¨ˆæ¸¬ä¸­ï¼");
    if (settings.voiceEnabled) tryStartRecognition(true);
  };

  const stopRun = () => {
    session.running = false;
    saveLS();
    updateMainUI();
    setStatus("åœæ­¢ã—ã¾ã—ãŸã€‚è¨˜éŒ²ã—ã¾ã™ã‹ï¼Ÿ");
    stopRecognition();
    if (session.todayCount > 0) openSaveModal();
  };

  const resetToday = () => {
    if (session.running) { alert("è¨ˆæ¸¬ä¸­ã¯ãƒªã‚»ãƒƒãƒˆã§ãã¾ã›ã‚“ã€‚Stopã—ã¦ã‹ã‚‰ãƒªã‚»ãƒƒãƒˆã—ã¦ãã ã•ã„ã€‚"); return; }
    if (!confirm("ä»Šæ—¥ã®ã‚«ã‚¦ãƒ³ãƒˆã‚’0ã«æˆ»ã—ã¾ã™ã€‚OKï¼Ÿ")) return;
    session.todayCount = 0;
    session.startedAtISO = null;
    saveLS();
    updateMainUI();
    setStatus("ä»Šæ—¥ã®ã‚«ã‚¦ãƒ³ãƒˆã‚’0ã«ã—ã¾ã—ãŸã€‚");
  };

  /* ===============================
     Save flow
     =============================== */
  let selectedMood = "ğŸ™‚";

  const openSaveModal = () => {
    selectedMood = "ğŸ™‚";
    commentBox.value = "";
    $$("#moodGrid .moodBtn").forEach(btn => btn.classList.toggle("active", btn.dataset.mood === selectedMood));
    const d = new Date();
    saveHint.textContent = `ä»Šæ—¥ï¼ˆ${formatDateJP(d)}ï¼‰ã®ç´ æŒ¯ã‚Šï¼š${session.todayCount} å›ã‚’ä¿å­˜ã—ã¾ã™ã€‚`;
    openModal(modalSaveOverlay);
  };

  const saveRecord = () => {
    const c = clampInt(session.todayCount);
    if (c <= 0) { closeModal(modalSaveOverlay); return; }

    const d = new Date();
    const rec = {
      id: crypto?.randomUUID ? crypto.randomUUID() : (String(Date.now()) + "_" + Math.random().toString(16).slice(2)),
      iso: d.toISOString(),
      dateLabel: formatDateJP(d),
      count: c,
      mood: selectedMood,
      comment: (commentBox.value || "").trim()
    };

    history.unshift(rec);
    session.todayCount = 0;
    session.startedAtISO = null;

    saveLS();
    closeModal(modalSaveOverlay);
    updateMainUI();
    renderHistory();
    updateTotals();
    setStatus("ä¿å­˜ã—ã¾ã—ãŸï¼");
  };

  /* ===============================
     History render (æŒ‡å®šãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ)
     æ—¥ä»˜
     å›æ•°
     æ°—åˆ† ã‚³ãƒ¡ãƒ³ãƒˆ
     =============================== */
  const renderHistory = () => {
    historyList.innerHTML = "";
    if (!history.length) {
      const empty = document.createElement("div");
      empty.className = "hint";
      empty.textContent = "ã¾ã å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“ã€‚Stop â†’ æ°—åˆ†ï¼†æ„Ÿæƒ³ â†’ ä¿å­˜ã§è¨˜éŒ²ãŒæ®‹ã‚Šã¾ã™ã€‚";
      historyList.appendChild(empty);
      updateSummaryMini();
      return;
    }

    for (const rec of history) {
      const el = document.createElement("div");
      el.className = "entry";

      const left = document.createElement("div");
      left.className = "left";

      const date = document.createElement("div");
      date.className = "date";
      date.textContent = rec.dateLabel;

      const count = document.createElement("div");
      count.className = "count";
      count.textContent = `${rec.count} å›`;

      const sub = document.createElement("div");
      sub.className = "sub";
      const moodAndComment = `${rec.mood} ${rec.comment || ""}`.trim();
      sub.textContent = moodAndComment || rec.mood;

      left.appendChild(date);
      left.appendChild(count);
      left.appendChild(sub);

      const right = document.createElement("div");
      right.className = "right";

      const del = document.createElement("button");
      del.className = "btn small gray";
      del.textContent = "å‰Šé™¤";
      del.onclick = () => {
        if (!confirm("ã“ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
        history = history.filter(h => h.id !== rec.id);
        saveLS();
        renderHistory();
        updateTotals();
        setStatus("å‰Šé™¤ã—ã¾ã—ãŸã€‚");
      };

      right.appendChild(del);
      el.appendChild(left);
      el.appendChild(right);
      historyList.appendChild(el);
    }

    updateSummaryMini();
  };

  const updateSummaryMini = () => {
    const total = history.reduce((a,b)=>a + (Number(b.count)||0), 0);
    summaryMini.textContent = history.length ? `å±¥æ­´ ${history.length} ä»¶ / ç´¯è¨ˆ ${total} å›` : "å±¥æ­´ 0 ä»¶";
  };

  /* ===============================
     Totals
     =============================== */
  const startOfDay = (d) => new Date(d.getFullYear(), d.getMonth(), d.getDate());
  const addDays = (d, days) => new Date(d.getTime() + days*24*60*60*1000);

  const getWeekRangeMonSun = (d0 = new Date()) => {
    const d = startOfDay(d0);
    const day = d.getDay();
    const diffToMon = (day === 0) ? -6 : (1 - day);
    const mon = addDays(d, diffToMon);
    const sun = addDays(mon, 6);
    return { mon, sun };
  };

  const updateTotals = () => {
    const now = new Date();
    const { mon, sun } = getWeekRangeMonSun(now);

    const startWeek = mon.getTime();
    const endWeek = addDays(sun, 1).getTime();

    const startMonth = new Date(now.getFullYear(), now.getMonth(), 1).getTime();
    const endMonth = new Date(now.getFullYear(), now.getMonth()+1, 1).getTime();

    let w=0, m=0, all=0;
    for (const rec of history) {
      const t = Date.parse(rec.iso || "");
      const c = Number(rec.count) || 0;
      all += c;
      if (t >= startWeek && t < endWeek) w += c;
      if (t >= startMonth && t < endMonth) m += c;
    }

    const wk = `${formatDateJP(mon)} ã€œ ${formatDateJP(sun)}`;
    const ml = `${now.getFullYear()}/${pad2(now.getMonth()+1)}`;

    // Home
    weekTotal.textContent = `${w} å›`;
    monthTotal.textContent = `${m} å›`;
    allTotal.textContent = `${all} å›`;
    weekRange.textContent = wk;
    monthLabel.textContent = ml;

    // History totals tab
    weekTotal2.textContent = `${w} å›`;
    monthTotal2.textContent = `${m} å›`;
    allTotal2.textContent = `${all} å›`;
    weekRange2.textContent = wk;
    monthLabel2.textContent = ml;

    updateSummaryMini();
  };

  /* ===============================
     CSV / JSON
     =============================== */
  const escapeCSV = (s) => {
    const str = String(s ?? "");
    if (/[",\n]/.test(str)) return `"${str.replace(/"/g,'""')}"`;
    return str;
  };

  const exportCSV = () => {
    const rows = [["date","count","mood","comment","iso"]];
    for (const r of history) rows.push([r.dateLabel, r.count, r.mood, r.comment || "", r.iso || ""]);
    const csv = rows.map(row => row.map(escapeCSV).join(",")).join("\n");
    const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "suburi_history.csv";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
    setStatus("CSVã‚’å‡ºåŠ›ã—ã¾ã—ãŸã€‚");
  };

  const backupJSON = () => {
    const payload = { version: 4, exportedAt: nowISO(), settings, history };
    const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "suburi_backup.json";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
    setStatus("JSONãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å‡ºåŠ›ã—ã¾ã—ãŸã€‚");
  };

  const restoreJSON = async (file) => {
    try{
      const text = await file.text();
      const obj = JSON.parse(text);
      if (!obj || typeof obj !== "object") throw new Error("invalid json");
      if (!Array.isArray(obj.history)) throw new Error("history missing");

      history = obj.history;
      if (obj.settings && typeof obj.settings === "object") settings = {...settings, ...obj.settings};

      session.running = false;
      session.todayCount = 0;
      session.startedAtISO = null;

      saveLS();
      updateSettingsUI();
      updateMainUI();
      renderHistory();
      updateTotals();
      setStatus("JSONã‹ã‚‰å¾©å…ƒã—ã¾ã—ãŸã€‚");
      alert("å¾©å…ƒã—ã¾ã—ãŸï¼");
    } catch(e){
      alert("å¾©å…ƒã«å¤±æ•—ã—ã¾ã—ãŸã€‚JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
      setStatus("å¾©å…ƒã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
    }
  };

  /* ===============================
     Settings UI
     =============================== */
  const updateSettingsUI = () => {
    toggleSound.textContent = settings.soundEnabled ? "ON" : "OFF";
    toggleSound.className = settings.soundEnabled ? "btn small green" : "btn small gray";

    toggleVoice.textContent = settings.voiceEnabled ? "ON" : "OFF";
    toggleVoice.className = settings.voiceEnabled ? "btn small green" : "btn small gray";

    voiceKeywordInput.value = settings.voiceKeyword || "ã¯ã„";
    updateVoiceHint();
    updateVoicePill();
  };

  /* ===============================
     History tabs
     =============================== */
  const setHistoryTab = (name) => {
    const isHistory = name === "history";
    tabHistory.classList.toggle("active", isHistory);
    tabTotals.classList.toggle("active", !isHistory);
    tabHistory.setAttribute("aria-selected", isHistory ? "true" : "false");
    tabTotals.setAttribute("aria-selected", !isHistory ? "true" : "false");
    panelHistory.style.display = isHistory ? "block" : "none";
    panelTotals.style.display = !isHistory ? "block" : "none";
    if (!isHistory) updateTotals();
  };

  /* ===============================
     Wire events
     =============================== */
  // Nav
  brandHome.addEventListener("click", () => showPage("home"));
  btnNavHistory.addEventListener("click", () => showPage("history"));
  btnNavSettings.addEventListener("click", () => showPage("settings"));

  btnGoHistory.addEventListener("click", () => showPage("history"));
  btnGoSettings.addEventListener("click", () => showPage("settings"));
  btnBackFromHistory.addEventListener("click", () => showPage("home"));
  btnBackFromSettings.addEventListener("click", () => showPage("home"));

  // Home actions
  btnStart.addEventListener("click", startRun);
  btnStop.addEventListener("click", stopRun);
  btnReset.addEventListener("click", resetToday);
  tapBtn.addEventListener("click", () => { if (session.running) incrementCount(1); });

  // Settings actions
  toggleSound.addEventListener("click", () => {
    settings.soundEnabled = !settings.soundEnabled;
    saveLS();
    updateSettingsUI();
    setStatus(`éŸ³ï¼š${settings.soundEnabled ? "ON" : "OFF"}`);
  });

  toggleVoice.addEventListener("click", () => {
    settings.voiceEnabled = !settings.voiceEnabled;
    if (settings.voiceEnabled && session.running) tryStartRecognition(false);
    else stopRecognition();
    saveLS();
    updateSettingsUI();
    updateMainUI();
    setStatus(`éŸ³å£°ï¼š${settings.voiceEnabled ? "ON" : "OFF"}`);
  });

  voiceKeywordInput.addEventListener("input", () => {
    const v = (voiceKeywordInput.value || "").trim();
    settings.voiceKeyword = v || "ã¯ã„";
    saveLS();
    updateSettingsUI();
    setStatus("éŸ³å£°ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚");
  });

  // History tabs
  tabHistory.addEventListener("click", () => setHistoryTab("history"));
  tabTotals.addEventListener("click", () => setHistoryTab("totals"));

  btnClearHistory.addEventListener("click", () => {
    if (!history.length) return;
    if (!confirm("å±¥æ­´ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã€‚OKï¼Ÿï¼ˆæˆ»ã›ã¾ã›ã‚“ï¼‰")) return;
    history = [];
    saveLS();
    renderHistory();
    updateTotals();
    setStatus("å±¥æ­´ã‚’å…¨å‰Šé™¤ã—ã¾ã—ãŸã€‚");
  });

  btnExportCSV.addEventListener("click", exportCSV);

  // Data modal
  btnNavData.addEventListener("click", () => openModal(modalDataOverlay));
  btnDataClose.addEventListener("click", () => closeModal(modalDataOverlay));
  modalDataOverlay.addEventListener("click", (e) => { if (e.target === modalDataOverlay) closeModal(modalDataOverlay); });

  btnBackupJSON.addEventListener("click", backupJSON);
  restoreJSONFile.addEventListener("change", (e) => {
    const file = e.target.files?.[0];
    if (!file) return;
    restoreJSON(file);
    e.target.value = "";
  });

  // Save modal
  btnSaveCancel.addEventListener("click", () => { closeModal(modalSaveOverlay); setStatus("ä¿å­˜ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸã€‚"); });
  $$("#moodGrid .moodBtn").forEach(btn => {
    btn.addEventListener("click", () => {
      selectedMood = btn.dataset.mood;
      $$("#moodGrid .moodBtn").forEach(b => b.classList.toggle("active", b.dataset.mood === selectedMood));
    });
  });
  btnSaveDone.addEventListener("click", saveRecord);

  // ESC
  document.addEventListener("keydown", (e) => {
    if (e.key !== "Escape") return;
    [modalDataOverlay, modalSaveOverlay].forEach(ov => {
      if (ov.style.display === "flex") closeModal(ov);
    });
    hideCelebration();
  });

  /* ===============================
     Init
     =============================== */
  const init = () => {
    loadLS();
    session.running = false; // èµ·å‹•æ™‚ã¯å®‰å…¨ã«åœæ­¢
    updateSettingsUI();
    updateMainUI();
    renderHistory();
    updateTotals();
    setHistoryTab("history");
    setStatus("æº–å‚™OK");
  };

  init();
})();
</script>
</body>
</html>
